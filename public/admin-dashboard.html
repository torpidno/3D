<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard ‚Äì 3D Prints</title>
  <link rel="icon" type="image/png" href="/Pauli.png" />
  <style>
    :root{--bg:#020617;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--border:rgba(255,255,255,0.1);--sidebar:#0f172a;--hover:rgba(255,255,255,0.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:260px;background:var(--sidebar);border-right:1px solid var(--border);padding:20px;position:fixed;height:100vh;overflow-y:auto;display:flex;flex-direction:column}
    .sidebar h2{margin:0 0 20px 0;font-size:20px;color:var(--accent)}
    .nav-menu{list-style:none;padding:0;margin:0}
    .nav-menu li{margin-bottom:8px}
    .nav-menu a{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;text-decoration:none;color:var(--text);transition:background 0.2s}
    .nav-menu a:hover{background:var(--hover)}
    .nav-menu a.active{background:var(--accent);color:#0b1220;font-weight:600}
    .nav-menu .icon{font-size:18px}
    .nav-menu a.btn-home{border:1px solid var(--border);background:transparent;justify-content:center}
    .nav-menu a.btn-home:hover{background:var(--hover);border-color:var(--accent)}
    .main-content{margin-left:260px;flex:1;padding:20px;max-width:1400px}
    .header{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{margin:0;font-size:28px}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-pill{padding:8px 14px;border-radius:999px;border:1px solid rgba(148,163,184,0.24);background:rgba(148,163,184,0.12);color:var(--muted);font-size:13px}
    .btn-logout{background:#ef4444;color:#fff;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:500}
    .btn-logout:hover{filter:brightness(1.1)}
    .overview-section{margin-bottom:32px}
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .stat-card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em}
    .stat-card .value{font-size:32px;font-weight:700;color:#f8fafc}
    .chart-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .chart-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .chart-card h3{margin:0 0 16px 0;font-size:18px;color:var(--text)}
    .bar-chart{display:flex;flex-direction:column;gap:12px}
    .bar-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .bar-label{font-size:13px;color:var(--muted);min-width:100px}
    .bar-track{background:rgba(148,163,184,0.12);border-radius:999px;height:14px;position:relative;overflow:hidden}
    .bar-fill{height:100%;border-radius:999px;width:0;transition:width .55s cubic-bezier(0.16,1,0.3,1)}
    .bar-value{font-weight:600;color:#f8fafc;font-size:14px;min-width:35px;text-align:right}
    .recent-section{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .recent-section h2{margin:0 0 20px 0;font-size:22px}
    .recent-list{list-style:none;padding:0;margin:0}
    .recent-item{padding:14px 0;border-bottom:1px solid var(--border)}
    .recent-item:last-child{border-bottom:none}
    .recent-item h4{margin:0 0 4px 0;font-size:15px}
    .recent-item p{margin:0;font-size:13px;color:var(--muted)}
    @media (max-width:768px){
      .sidebar{width:100%;height:auto;position:relative;border-right:none;border-bottom:1px solid var(--border)}
      .main-content{margin-left:0}
      .layout{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2>üñ®Ô∏è 3D Admin</h2>
      <ul class="nav-menu">
        <li><a href="/admin" class="active"><span class="icon">üìä</span> √ñversikt</a></li>
        <li><a href="/admin/my-prints"><span class="icon">üé®</span> Mina Prints</a></li>
        <li><a href="/admin/other-prints"><span class="icon">üë§</span> Andras Prints</a></li>
        <li><a href="/admin/completed"><span class="icon">‚úÖ</span> F√§rdiga Prints</a></li>
      </ul>
      <ul class="nav-menu" style="margin-top:auto">
        <li><a href="/" class="btn-home">Till startsidan</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="header">
        <h1>Dashboard √ñversikt</h1>
        <div class="user-info">
          <span class="user-pill" id="userDisplay">Laddar...</span>
          <a href="/logout" class="btn-logout">Logga ut</a>
        </div>
      </div>

      <section class="overview-section">
        <div class="stat-grid">
          <div class="stat-card">
            <h3>Aktiva √Ñrenden</h3>
            <div class="value" id="activeCount">0</div>
          </div>
          <div class="stat-card">
            <h3>Avslutade</h3>
            <div class="value" id="doneCount">0</div>
          </div>
          <div class="stat-card">
            <h3>Totalt Registrerade</h3>
            <div class="value" id="totalCount">0</div>
          </div>
        </div>

        <div class="chart-grid">
          <div class="chart-card">
            <h3>Status</h3>
            <div class="bar-chart" id="statusChart"></div>
          </div>
          <div class="chart-card">
            <h3>Preferens</h3>
            <div class="bar-chart" id="preferensChart"></div>
          </div>
          <div class="chart-card">
            <h3>Hur Br√•ttom</h3>
            <div class="bar-chart" id="urgencyChart"></div>
          </div>
        </div>
      </section>

      <section class="recent-section">
        <h2>Senaste Inskickade</h2>
        <ul class="recent-list" id="recentList">
          <li class="recent-item">Laddar...</li>
        </ul>
      </section>
    </main>
  </div>

  <script>
    (async function() {
      try {
        // Fetch user info
        const userRes = await fetch('/api/admin/user');
        const userData = await userRes.json();
        document.getElementById('userDisplay').textContent = `Inloggad som ${userData.displayName || userData.username}`;

        // Fetch submissions
        const res = await fetch('/api/admin/submissions');
        const submissions = await res.json();
        
        const actives = submissions.filter(s => !s.done);
        const finished = submissions.filter(s => s.done);
        
        document.getElementById('activeCount').textContent = actives.length;
        document.getElementById('doneCount').textContent = finished.length;
        document.getElementById('totalCount').textContent = submissions.length;

        // Status chart
        const statusData = [
          { label: 'Aktiva', value: actives.length, color: '#38bdf8' },
          { label: 'Klara', value: finished.length, color: '#22c55e' }
        ];
        renderChart('statusChart', statusData, submissions.length);

        // Preferens chart
        const preferensData = [
          { label: 'Noah', value: submissions.filter(s => s.preferens === 'Noah').length, color: '#60a5fa' },
          { label: 'Alex', value: submissions.filter(s => s.preferens === 'Alex').length, color: '#7c3aed' },
          { label: 'Vem som', value: submissions.filter(s => s.preferens === 'Vem som').length, color: '#38bdf8' }
        ];
        renderChart('preferensChart', preferensData, submissions.length);

        // Filter for urgency based on user role
        let urgencySource = submissions;
        if (userData.role === 'noah') {
          urgencySource = submissions.filter(s => s.preferens === 'Noah' || s.preferens === 'Vem som');
        } else if (userData.role === 'alex') {
          urgencySource = submissions.filter(s => s.preferens === 'Alex' || s.preferens === 'Vem som');
        }

        const urgencyData = [
          { label: 'Inte br√•ttom', value: urgencySource.filter(s => s.brattom === 'Inte br√•ttom').length, color: '#16a34a' },
          { label: 'Snart', value: urgencySource.filter(s => s.brattom === 'Snart').length, color: '#facc15' },
          { label: 'Mycket br√•ttom', value: urgencySource.filter(s => s.brattom === 'Mycket br√•ttom').length, color: '#f97316' }
        ];
        renderChart('urgencyChart', urgencyData, urgencySource.length);

        // Recent submissions
        const recent = [...submissions].sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)).slice(0, 5);
        const recentList = document.getElementById('recentList');
        if (recent.length === 0) {
          recentList.innerHTML = '<li class="recent-item"><p>Inga inskickade prints √§n.</p></li>';
        } else {
          recentList.innerHTML = recent.map(s => {
            const date = new Date(s.submittedAt);
            const dateStr = date.toLocaleString('sv-SE', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            return `<li class="recent-item">
              <h4>${escapeHtml(s.namn)} ‚Üí ${escapeHtml(s.preferens)}</h4>
              <p>${dateStr} ‚Ä¢ ${escapeHtml(s.brattom)}</p>
            </li>`;
          }).join('');
        }

      } catch (err) {
        console.error('Failed to load dashboard data', err);
      }
    })();

    function renderChart(elementId, data, total) {
      const container = document.getElementById(elementId);
      container.innerHTML = data.map(item => {
        const percent = total > 0 ? Math.round((item.value / total) * 100) : 0;
        const width = item.value > 0 ? Math.max(percent, 10) : 0;
        return `<div class="bar-row">
          <span class="bar-label">${item.label}</span>
          <div class="bar-track">
            <div class="bar-fill" data-target="${width}" style="width:0;background:${item.color}"></div>
          </div>
          <span class="bar-value">${item.value}</span>
        </div>`;
      }).join('');

      // Animate bars
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          document.querySelectorAll('.bar-fill').forEach(el => {
            const target = el.getAttribute('data-target');
            if (target) el.style.width = target + '%';
          });
        });
      });
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
