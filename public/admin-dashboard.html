<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard ‚Äì 3D Prints</title>
  <link rel="icon" type="image/png" href="/Pauli.png" />
  <style>
    :root{--bg:#020617;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--border:rgba(255,255,255,0.1);--sidebar:#0f172a;--hover:rgba(255,255,255,0.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:260px;background:var(--sidebar);border-right:1px solid var(--border);padding:20px;position:fixed;height:100vh;overflow-y:auto;display:flex;flex-direction:column;z-index:999}
    .sidebar h2{margin:0 0 20px 0;font-size:20px;color:var(--accent)}
    .nav-menu{list-style:none;padding:0;margin:0}
    .nav-menu li{margin-bottom:8px}
    .nav-menu a{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;text-decoration:none;color:var(--text);transition:background 0.2s}
    .nav-menu a:hover{background:var(--hover)}
    .nav-menu a.active{background:var(--accent);color:#0b1220;font-weight:600}
    .nav-menu .icon{font-size:18px}
    .nav-menu a.btn-home{border:1px solid var(--border);background:transparent;justify-content:center}
    .nav-menu a.btn-home:hover{background:var(--hover);border-color:var(--accent)}
    .hamburger{display:none;position:fixed;top:20px;left:20px;z-index:1001;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;width:44px;height:44px;flex-direction:column;justify-content:center;align-items:center;gap:5px}
    .hamburger span{display:block;width:24px;height:3px;background:var(--text);border-radius:2px;transition:all 0.3s}
    .hamburger.active span:nth-child(1){transform:rotate(45deg) translate(7px,7px)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(7px,-7px)}
    .sidebar-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:998}
    .main-content{margin-left:260px;flex:1;padding:20px;max-width:1600px}
    .header{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{margin:0;font-size:28px}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-pill{padding:8px 14px;border-radius:999px;border:1px solid rgba(148,163,184,0.24);background:rgba(148,163,184,0.12);color:var(--muted);font-size:13px}
    .btn-logout{background:#ef4444;color:#fff;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:500}
    .btn-logout:hover{filter:brightness(1.1)}
    .overview-section{margin-bottom:32px}
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
    .stat-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .stat-card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:0.06em}
    .stat-card .value{font-size:32px;font-weight:700;color:#f8fafc}
    .chart-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .chart-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .chart-card h3{margin:0 0 16px 0;font-size:18px;color:var(--text)}
    .bar-chart{display:flex;flex-direction:column;gap:12px}
    .bar-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .bar-label{font-size:13px;color:var(--muted);min-width:100px}
    .bar-track{background:rgba(148,163,184,0.12);border-radius:999px;height:14px;position:relative;overflow:hidden}
    .bar-fill{height:100%;border-radius:999px;width:0;transition:width .55s cubic-bezier(0.16,1,0.3,1)}
    .bar-value{font-weight:600;color:#f8fafc;font-size:14px;min-width:35px;text-align:right}
    .recent-section{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:24px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
    .recent-section h2{margin:0 0 20px 0;font-size:22px}
    .recent-list{list-style:none;padding:0;margin:0}
    .recent-item{padding:14px 0;border-bottom:1px solid var(--border)}
    .recent-item:last-child{border-bottom:none}
    .recent-item h4{margin:0 0 4px 0;font-size:15px}
    .recent-item p{margin:0;font-size:13px;color:var(--muted)}
    .user-pill{cursor:pointer;transition:all 0.2s}
    .user-pill:hover{background:rgba(148,163,184,0.2);border-color:rgba(148,163,184,0.4)}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:30px;max-width:500px;width:90%;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .modal-header{margin-bottom:24px}
    .modal-header h2{margin:0;font-size:24px}
    .modal-close{float:right;font-size:28px;font-weight:bold;color:var(--muted);cursor:pointer;line-height:20px}
    .modal-close:hover{color:var(--text)}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;color:var(--muted);font-size:14px;font-weight:500}
    .form-group input{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:14px}
    .form-group input:focus{outline:none;border-color:var(--accent)}
    .form-group input:disabled{opacity:0.5;cursor:not-allowed}
    .btn-primary{background:var(--accent);color:#0b1220;padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;width:100%;margin-top:8px}
    .btn-primary:hover{filter:brightness(1.1)}
    .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
    .alert{padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px}
    .alert-success{background:rgba(34,197,94,0.2);border:1px solid rgba(34,197,94,0.4);color:#86efac}
    .alert-error{background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#fca5a5}
    @media (max-width:768px){
      .hamburger{display:flex}
      .sidebar{transform:translateX(-100%);transition:transform 0.3s ease}
      .sidebar.mobile-open{transform:translateX(0)}
      .sidebar-overlay.show{display:block}
      .main-content{margin-left:0;padding-top:80px}
      .header{margin-top:0}
      .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
      table{min-width:900px}
    }
  </style>
</head>
<body>
  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <h2>3D Admin</h2>
      <ul class="nav-menu">
        <li><a href="/admin" class="active"><span class="icon"></span> √ñversikt</a></li>
        <li><a href="/admin/my-prints"><span class="icon"></span> Mina Prints</a></li>
        <li><a href="/admin/other-prints"><span class="icon"></span> Andras Prints</a></li>
        <li><a href="/admin/completed"><span class="icon"></span> F√§rdiga Prints</a></li>
      </ul>
      <div id="masterMenu" style="display:none">
        <div style="height:1px;background:rgba(255,255,255,0.1);margin:16px 0"></div>
        <ul class="nav-menu">
          <li><a href="/admin/users"><span class="icon">üë•</span> Anv√§ndarhantering</a></li>
        </ul>
      </div>
      <ul class="nav-menu" style="margin-top:auto">
        <li><a href="/" class="btn-home">Till startsidan</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="header">
        <h1>Dashboard √ñversikt</h1>
        <div class="user-info">
          <span class="user-pill" id="userDisplay" title="Klicka f√∂r att √§ndra profil">Laddar...</span>
          <a href="/logout" class="btn-logout">Logga ut</a>
        </div>
      </div>

      <!-- Profile Settings Modal -->
      <div id="profileModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-close" id="closeModal">&times;</span>
            <h2>Profilinst√§llningar</h2>
          </div>
          <div id="profileAlert"></div>
          <form id="profileForm">
            <div class="form-group">
              <label for="currentUsername">Nuvarande anv√§ndarnamn</label>
              <input type="text" id="currentUsername" disabled />
            </div>
            <div class="form-group">
              <label for="newUsername">Nytt anv√§ndarnamn (valfritt)</label>
              <input type="text" id="newUsername" placeholder="L√§mna tomt f√∂r att beh√•lla" />
            </div>
            <div class="form-group">
              <label for="currentPassword">Nuvarande l√∂senord</label>
              <input type="password" id="currentPassword" required />
            </div>
            <div class="form-group">
              <label for="newPassword">Nytt l√∂senord (valfritt)</label>
              <input type="password" id="newPassword" placeholder="L√§mna tomt f√∂r att beh√•lla" />
            </div>
            <div class="form-group">
              <label for="confirmPassword">Bekr√§fta nytt l√∂senord</label>
              <input type="password" id="confirmPassword" placeholder="Endast om du byter l√∂senord" />
            </div>
            <button type="submit" class="btn-primary" id="saveProfileBtn">Spara √§ndringar</button>
          </form>
        </div>
      </div>

      <section class="overview-section">
        <div class="stat-grid">
          <div class="stat-card">
            <h3>Aktiva √Ñrenden</h3>
            <div class="value" id="activeCount">0</div>
          </div>
          <div class="stat-card">
            <h3>Avslutade</h3>
            <div class="value" id="doneCount">0</div>
          </div>
          <div class="stat-card">
            <h3>Totalt Registrerade</h3>
            <div class="value" id="totalCount">0</div>
          </div>
        </div>

        <div class="chart-grid">
          <div class="chart-card">
            <h3>Status</h3>
            <div class="bar-chart" id="statusChart"></div>
          </div>
          <div class="chart-card">
            <h3>Preferens</h3>
            <div class="bar-chart" id="preferensChart"></div>
          </div>
          <div class="chart-card">
            <h3>Hur Br√•ttom</h3>
            <div class="bar-chart" id="urgencyChart"></div>
          </div>
        </div>
      </section>

      <section class="recent-section">
        <h2>Senaste Inskickade</h2>
        <ul class="recent-list" id="recentList">
          <li class="recent-item">Laddar...</li>
        </ul>
      </section>
    </main>
  </div>

  <script>
    // Hamburger menu functionality
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function toggleSidebar() {
      hamburger.classList.toggle('active');
      sidebar.classList.toggle('mobile-open');
      sidebarOverlay.classList.toggle('show');
    }

    hamburger.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);

    // Close sidebar when clicking a link on mobile
    const navLinks = sidebar.querySelectorAll('a');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          toggleSidebar();
        }
      });
    });

    (async function() {
      try {
        // Fetch user info
        const userRes = await fetch('/api/admin/user');
        const userData = await userRes.json();
        document.getElementById('userDisplay').textContent = `Inloggad som ${userData.displayName || userData.username}`;

        // Show master menu if user is master
        if (userData.role === 'master') {
          document.getElementById('masterMenu').style.display = 'block';
        }

        // Fetch submissions
        const res = await fetch('/api/admin/submissions');
        const submissions = await res.json();
        
        const actives = submissions.filter(s => !s.done);
        const finished = submissions.filter(s => s.done);
        
        document.getElementById('activeCount').textContent = actives.length;
        document.getElementById('doneCount').textContent = finished.length;
        document.getElementById('totalCount').textContent = submissions.length;

        // Status chart
        const statusData = [
          { label: 'Aktiva', value: actives.length, color: '#38bdf8' },
          { label: 'Klara', value: finished.length, color: '#22c55e' }
        ];
        renderChart('statusChart', statusData, submissions.length);

        // Preferens chart
        const preferensData = [
          { label: 'Noah', value: submissions.filter(s => s.preferens === 'Noah').length, color: '#60a5fa' },
          { label: 'Alex', value: submissions.filter(s => s.preferens === 'Alex').length, color: '#7c3aed' },
          { label: 'Vem som', value: submissions.filter(s => s.preferens === 'Vem som').length, color: '#38bdf8' }
        ];
        renderChart('preferensChart', preferensData, submissions.length);

        // Filter for urgency based on user role
        let urgencySource = submissions;
        if (userData.role === 'noah') {
          urgencySource = submissions.filter(s => s.preferens === 'Noah' || s.preferens === 'Vem som');
        } else if (userData.role === 'alex') {
          urgencySource = submissions.filter(s => s.preferens === 'Alex' || s.preferens === 'Vem som');
        }

        const urgencyData = [
          { label: 'Inte br√•ttom', value: urgencySource.filter(s => s.brattom === 'Inte br√•ttom').length, color: '#16a34a' },
          { label: 'Snart', value: urgencySource.filter(s => s.brattom === 'Snart').length, color: '#facc15' },
          { label: 'Mycket br√•ttom', value: urgencySource.filter(s => s.brattom === 'Mycket br√•ttom').length, color: '#f97316' }
        ];
        renderChart('urgencyChart', urgencyData, urgencySource.length);

        // Recent submissions
        const recent = [...submissions].sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt)).slice(0, 5);
        const recentList = document.getElementById('recentList');
        if (recent.length === 0) {
          recentList.innerHTML = '<li class="recent-item"><p>Inga inskickade prints √§n.</p></li>';
        } else {
          recentList.innerHTML = recent.map(s => {
            const date = new Date(s.submittedAt);
            const dateStr = date.toLocaleString('sv-SE', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            return `<li class="recent-item">
              <h4>${escapeHtml(s.namn)} ‚Üí ${escapeHtml(s.preferens)}</h4>
              <p>${dateStr} ‚Ä¢ ${escapeHtml(s.brattom)}</p>
            </li>`;
          }).join('');
        }

      } catch (err) {
        console.error('Failed to load dashboard data', err);
      }
    })();

    function renderChart(elementId, data, total) {
      const container = document.getElementById(elementId);
      container.innerHTML = data.map(item => {
        const percent = total > 0 ? Math.round((item.value / total) * 100) : 0;
        const width = item.value > 0 ? Math.max(percent, 10) : 0;
        return `<div class="bar-row">
          <span class="bar-label">${item.label}</span>
          <div class="bar-track">
            <div class="bar-fill" data-target="${width}" style="width:0;background:${item.color}"></div>
          </div>
          <span class="bar-value">${item.value}</span>
        </div>`;
      }).join('');

      // Animate bars
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          document.querySelectorAll('.bar-fill').forEach(el => {
            const target = el.getAttribute('data-target');
            if (target) el.style.width = target + '%';
          });
        });
      });
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Profile modal functionality
    const profileModal = document.getElementById('profileModal');
    const userDisplay = document.getElementById('userDisplay');
    const closeModal = document.getElementById('closeModal');
    const profileForm = document.getElementById('profileForm');
    const profileAlert = document.getElementById('profileAlert');

    userDisplay.addEventListener('click', () => {
      profileModal.classList.add('show');
    });

    closeModal.addEventListener('click', () => {
      profileModal.classList.remove('show');
      profileForm.reset();
      profileAlert.innerHTML = '';
    });

    window.addEventListener('click', (e) => {
      if (e.target === profileModal) {
        profileModal.classList.remove('show');
        profileForm.reset();
        profileAlert.innerHTML = '';
      }
    });

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newUsername = document.getElementById('newUsername').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Validation
      if (newPassword && newPassword !== confirmPassword) {
        showAlert('L√∂senorden matchar inte!', 'error');
        return;
      }

      if (!currentPassword) {
        showAlert('Du m√•ste ange ditt nuvarande l√∂senord', 'error');
        return;
      }

      if (!newUsername && !newPassword) {
        showAlert('Du m√•ste √§ndra minst anv√§ndarnamn eller l√∂senord', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveProfileBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Sparar...';

      try {
        const res = await fetch('/api/admin/profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            currentPassword,
            newUsername: newUsername || undefined,
            newPassword: newPassword || undefined
          })
        });

        const data = await res.json();

        if (res.ok) {
          showAlert('Profil uppdaterad! Loggar in med nya uppgifter...', 'success');
          setTimeout(() => {
            window.location.href = '/admin';
          }, 1500);
        } else {
          showAlert(data.message || 'Kunde inte uppdatera profil', 'error');
          saveBtn.disabled = false;
          saveBtn.textContent = 'Spara √§ndringar';
        }
      } catch (err) {
        console.error('Profile update error:', err);
        showAlert('Ett fel uppstod. F√∂rs√∂k igen.', 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Spara √§ndringar';
      }
    });

    function showAlert(message, type) {
      profileAlert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    // Set current username when modal opens
    userDisplay.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/admin/user');
        const userData = await res.json();
        document.getElementById('currentUsername').value = userData.username;
      } catch (err) {
        console.error('Failed to fetch user data', err);
      }
    });
  </script>
</body>
</html>
