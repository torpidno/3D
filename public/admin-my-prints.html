<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mina Prints ‚Äì 3D Admin</title>
  <link rel="icon" type="image/png" href="/Pauli.png" />
  <style>
    :root{--bg:#020617;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--border:rgba(255,255,255,0.1);--sidebar:#0f172a;--hover:rgba(255,255,255,0.06)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .layout{display:flex;min-height:100vh}
    .sidebar{width:260px;background:var(--sidebar);border-right:1px solid var(--border);padding:20px;position:fixed;height:100vh;overflow-y:auto;display:flex;flex-direction:column;z-index:999}
    .sidebar h2{margin:0 0 20px 0;font-size:20px;color:var(--accent)}
    .nav-menu{list-style:none;padding:0;margin:0}
    .nav-menu li{margin-bottom:8px}
    .nav-menu a{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:10px;text-decoration:none;color:var(--text);transition:background 0.2s}
    .nav-menu a:hover{background:var(--hover)}
    .nav-menu a.active{background:var(--accent);color:#0b1220;font-weight:600}
    .nav-menu .icon{font-size:18px}
    .nav-menu a.btn-home{border:1px solid var(--border);background:transparent;justify-content:center}
    .nav-menu a.btn-home:hover{background:var(--hover);border-color:var(--accent)}
    .hamburger{display:none;position:fixed;top:20px;left:20px;z-index:1001;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;width:44px;height:44px;flex-direction:column;justify-content:center;align-items:center;gap:5px}
    .hamburger span{display:block;width:24px;height:3px;background:var(--text);border-radius:2px;transition:all 0.3s}
    .hamburger.active span:nth-child(1){transform:rotate(45deg) translate(7px,7px)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:rotate(-45deg) translate(7px,-7px)}
    .sidebar-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:998}
    .main-content{margin-left:260px;flex:1;padding:20px;max-width:1600px}
    .header{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{margin:0;font-size:28px}
    .user-info{display:flex;align-items:center;gap:12px}
    .user-pill{padding:8px 14px;border-radius:999px;border:1px solid rgba(148,163,184,0.24);background:rgba(148,163,184,0.12);color:var(--muted);font-size:13px;cursor:pointer;transition:all 0.2s}
    .user-pill:hover{background:rgba(148,163,184,0.2);border-color:rgba(148,163,184,0.4)}
    .btn-logout{background:#ef4444;color:#fff;padding:8px 14px;border-radius:8px;text-decoration:none;font-weight:500}
    .btn-logout:hover{filter:brightness(1.1)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,0.45);margin-bottom:20px}
    .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .card-header h2{margin:0;font-size:20px}
    .card-body{padding:0}
    .table-wrap{overflow:auto;border-radius:14px}
    table{width:100%;border-collapse:separate;border-spacing:0;color:var(--text)}
    th,td{padding:12px 14px;vertical-align:top;text-align:left}
    thead th{position:sticky;top:0;background:#0f172a;border-bottom:1px solid var(--border);font-weight:600}
    tbody tr{border-bottom:1px solid var(--border)}
    tbody tr:nth-child(even){background:rgba(255,255,255,0.02)}
    tbody tr:hover{background:var(--hover)}
    .wrap{word-break:break-word;white-space:pre-wrap}
    .idx{color:var(--muted);font-size:13px}
    a{color:#93c5fd;text-decoration:none}
    a:hover{text-decoration:underline}
    .btn-del,.btn-claim,.btn-unclaim,.btn-view{display:inline-block;margin:4px 4px 4px 0;padding:8px 14px;border-radius:8px;font-size:13px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
    .btn-del{background:#ef4444;color:#fff}
    .btn-del:hover{background:#dc2626;transform:translateY(-1px);box-shadow:0 4px 10px rgba(239,68,68,0.4)}
    .btn-claim{background:#22c55e;color:#fff}
    .btn-claim:hover{background:#16a34a;transform:translateY(-1px);box-shadow:0 4px 10px rgba(34,197,94,0.4)}
    .btn-unclaim{background:#f97316;color:#fff}
    .btn-unclaim:hover{background:#ea580c;transform:translateY(-1px);box-shadow:0 4px 10px rgba(249,115,22,0.4)}
    .btn-view{background:#60a5fa;color:#0b1220}
    .btn-view:hover{background:#3b82f6;transform:translateY(-1px);box-shadow:0 4px 10px rgba(96,165,250,0.5)}
    td a{display:inline-block;margin:4px 4px 4px 0;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:600;transition:all 0.2s;box-shadow:0 2px 6px rgba(0,0,0,0.3);background:rgba(147,197,253,0.15);color:#93c5fd;text-decoration:none;border:1px solid rgba(147,197,253,0.3)}
    td a:hover{background:rgba(147,197,253,0.25);border-color:#93c5fd;transform:translateY(-1px);box-shadow:0 4px 10px rgba(147,197,253,0.3);text-decoration:none}
    .claimed{color:#60a5fa;font-size:0.9em;margin-left:4px}
    .beskrivning-cell.long-desc{cursor:pointer}
    .show-more{color:#93c5fd;font-size:12px;margin-left:4px}
    .desc-modal-bg{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);z-index:1000;display:flex;align-items:center;justify-content:center}
    .desc-modal{background:#111827;color:#e5e7eb;padding:28px 32px;border-radius:14px;max-width:520px;box-shadow:0 8px 32px #000a;font-size:1.05em;position:relative;max-height:80vh;overflow-y:auto}
    .desc-close{position:absolute;top:12px;right:14px;background:#ef4444;color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-weight:600}
    th.sortable{cursor:pointer;user-select:none}
    th.sortable::after{content:'‚Üï';font-size:12px;opacity:.6;margin-left:6px}
    th.sortable[aria-sort="ascending"]::after{content:'‚ñ≤';opacity:.95}
    th.sortable[aria-sort="descending"]::after{content:'‚ñº';opacity:.95}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:30px;max-width:500px;width:90%;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .modal-header{margin-bottom:24px}
    .modal-header h2{margin:0;font-size:24px}
    .modal-close{float:right;font-size:28px;font-weight:bold;color:var(--muted);cursor:pointer;line-height:20px}
    .modal-close:hover{color:var(--text)}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;color:var(--muted);font-size:14px;font-weight:500}
    .form-group input{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text);font-size:14px}
    .form-group input:focus{outline:none;border-color:var(--accent)}
    .form-group input:disabled{opacity:0.5;cursor:not-allowed}
    .btn-primary{background:var(--accent);color:#0b1220;padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;width:100%;margin-top:8px}
    .btn-primary:hover{filter:brightness(1.1)}
    .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
    .alert{padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px}
    .alert-success{background:rgba(34,197,94,0.2);border:1px solid rgba(34,197,94,0.4);color:#86efac}
    .alert-error{background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.4);color:#fca5a5}
    @media (max-width:768px){
      .hamburger{display:flex}
      .sidebar{transform:translateX(-100%);transition:transform 0.3s ease}
      .sidebar.mobile-open{transform:translateX(0)}
      .sidebar-overlay.show{display:block}
      .main-content{margin-left:0;padding-top:80px}
      .header{margin-top:0}
      .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
      table{min-width:900px}
    }
  </style>
  <!-- 3D Viewer libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/3MFLoader.js"></script>
</head>
<body>
  <div class="hamburger" id="hamburger">
    <span></span>
    <span></span>
    <span></span>
  </div>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <h2>3D Admin</h2>
      <ul class="nav-menu">
        <li><a href="/admin"><span class="icon"></span> √ñversikt</a></li>
        <li><a href="/admin/my-prints" class="active"><span class="icon"></span> Mina Prints</a></li>
        <li><a href="/admin/other-prints"><span class="icon"></span> Andras Prints</a></li>
        <li><a href="/admin/completed"><span class="icon"></span> F√§rdiga Prints</a></li>
      </ul>
      <div id="masterMenu" style="display:none">
        <div style="height:1px;background:rgba(255,255,255,0.1);margin:16px 0"></div>
        <ul class="nav-menu">
          <li><a href="/admin/users"><span class="icon">üë•</span> Anv√§ndarhantering</a></li>
        </ul>
      </div>
      <ul class="nav-menu" style="margin-top:auto">
        <li><a href="/" class="btn-home">Till startsidan</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="header">
        <h1>Mina Prints</h1>
        <div class="user-info">
          <span class="user-pill" id="userDisplay" title="Klicka f√∂r att √§ndra profil">Laddar...</span>
          <a href="/logout" class="btn-logout">Logga ut</a>
        </div>
      </div>

      <!-- Profile Settings Modal -->
      <div id="profileModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-close" id="closeModal">&times;</span>
            <h2>Profilinst√§llningar</h2>
          </div>
          <div id="profileAlert"></div>
          <form id="profileForm">
            <div class="form-group">
              <label for="currentUsername">Nuvarande anv√§ndarnamn</label>
              <input type="text" id="currentUsername" disabled />
            </div>
            <div class="form-group">
              <label for="newUsername">Nytt anv√§ndarnamn (valfritt)</label>
              <input type="text" id="newUsername" placeholder="L√§mna tomt f√∂r att beh√•lla" />
            </div>
            <div class="form-group">
              <label for="currentPassword">Nuvarande l√∂senord</label>
              <input type="password" id="currentPassword" required />
            </div>
            <div class="form-group">
              <label for="newPassword">Nytt l√∂senord (valfritt)</label>
              <input type="password" id="newPassword" placeholder="L√§mna tomt f√∂r att beh√•lla" />
            </div>
            <div class="form-group">
              <label for="confirmPassword">Bekr√§fta nytt l√∂senord</label>
              <input type="password" id="confirmPassword" placeholder="Endast om du byter l√∂senord" />
            </div>
            <button type="submit" class="btn-primary" id="saveProfileBtn">Spara √§ndringar</button>
          </form>
        </div>
      </div>

      <!-- 3D Viewer Modal -->
      <div id="viewerModal" class="modal">
        <div class="modal-content" style="max-width:860px;width:92%">
          <div class="modal-header">
            <span class="modal-close" id="closeViewer">&times;</span>
            <h2>3D F√∂rhandsvisning</h2>
          </div>
          <div style="margin-bottom:8px;color:var(--muted);font-size:13px">Dra f√∂r att rotera ‚Ä¢ Scrolla f√∂r att zooma</div>
          <div id="viewer3d" style="width:100%;height:520px;border:1px solid var(--border);border-radius:10px;background:rgba(255,255,255,0.04)"></div>
          <div id="viewerMsg" class="hint" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>Aktiva Prints</h2>
        </div>
        <div class="card-body table-wrap">
          <table id="activeTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Klar</th>
                <th class="sortable" data-index="2">Namn</th>
                <th class="sortable" data-index="3">Mejl</th>
                <th class="sortable" data-index="4">Beskrivning</th>
                <th class="sortable" data-index="5">Preferens</th>
                <th class="sortable" data-index="6">Hur br√•ttom</th>
                <th class="sortable" data-index="7" data-type="date">Inskickad</th>
                <th>√Ötg√§rder</th>
              </tr>
            </thead>
            <tbody id="activeBody">
              <tr><td colspan="9" style="text-align:center;padding:20px">Laddar...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Hamburger menu functionality
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function toggleSidebar() {
      hamburger.classList.toggle('active');
      sidebar.classList.toggle('mobile-open');
      sidebarOverlay.classList.toggle('show');
    }

    hamburger.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', toggleSidebar);

    // Close sidebar when clicking a link on mobile
    const navLinks = sidebar.querySelectorAll('a');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          toggleSidebar();
        }
      });
    });

    let userRole = '';

    (async function() {
      try {
        // Fetch user info
        const userRes = await fetch('/api/admin/user');
        const userData = await userRes.json();
        userRole = userData.role;
        document.getElementById('userDisplay').textContent = `Inloggad som ${userData.displayName || userData.username}`;

        // Show master menu if user is master
        if (userRole === 'master') {
          document.getElementById('masterMenu').style.display = 'block';
        }

        // Fetch submissions
        const res = await fetch('/api/admin/submissions');
        let submissions = await res.json();

        // Get display name for filtering (capitalize first letter of role)
        const myDisplayName = userRole.charAt(0).toUpperCase() + userRole.slice(1);

        // Filter: show own prints + "Vem som"
        if (userRole === 'master') {
          // Master sees everything
        } else if (userRole === 'admin') {
          // Admin sees everything
        } else {
          // Regular users see their own prints + "Vem som"
          submissions = submissions.filter(s => s.preferens === myDisplayName || s.preferens === 'Vem som');
        }

        const actives = submissions.filter(s => !s.done).reverse();

        renderTable('activeBody', actives, false);

        initSortable('activeTable');

      } catch (err) {
        console.error('Failed to load prints', err);
      }
    })();

    function renderTable(bodyId, items, isDone) {
      const tbody = document.getElementById(bodyId);
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px">Inga prints h√§r.</td></tr>';
        return;
      }

      tbody.innerHTML = items.map((s, idx) => {
        let claimed = '';
        // Show "(vem som)" badge for any claimed print that was originally "Vem som"
        if (s.preferens !== 'Vem som' && s.originalPreferens === 'Vem som') {
          claimed = ' <span class="claimed">(vem som)</span>';
        }

        const descCell = renderDescriptionCell(s.beskrivning);
        const dateStr = formatShortDate(s.submittedAt);
        const extName = ((s.file && (s.file.originalName || s.file.storedName)) || '').toLowerCase();
        const viewExt = extName.endsWith('.stl') ? 'stl' : '3mf';

        const actions = [
          `<button type=\"button\" class=\"btn-view\" data-view-id=\"${s.id}\" data-ext=\"${viewExt}\">Visa</button>`,
          `<a href=\"/admin/download/${s.id}\">Ladda ner</a>`
        ];

        actions.push(`<button type="button" class="btn-del" data-id="${s.id}">Ta bort</button>`);

        // All users except admin can claim/unclaim
        const canClaimUnclaim = userRole !== 'admin';
        if (canClaimUnclaim && s.preferens === 'Vem som' && !isDone) {
          actions.push(`<button type="button" class="btn-claim" data-id="${s.id}">Ta √∂ver</button>`);
        }

        // Check if this is a claimed "Vem som" print (not hardcoded to specific names)
        if (canClaimUnclaim && s.preferens !== 'Vem som' && s.originalPreferens === 'Vem som' && !isDone) {
          actions.push(`<button type="button" class="btn-unclaim" data-id="${s.id}">√Öngra</button>`);
        }

        return `<tr data-id="${s.id}">
          <td class="idx">${idx + 1}</td>
          <td><input type="checkbox" class="toggle-done" data-id="${s.id}" ${isDone ? 'checked' : ''} /></td>
          <td>${escapeHtml(s.namn)}</td>
          <td><a href="mailto:${escapeHtml(s.mejl)}">${escapeHtml(s.mejl)}</a></td>
          ${descCell}
          <td>${escapeHtml(s.preferens)}${claimed}</td>
          <td>${escapeHtml(s.brattom)}</td>
          <td data-sort="${new Date(s.submittedAt).getTime()}">${dateStr}</td>
          <td>${actions.join(' ')}</td>
        </tr>`;
      }).join('');
    }

    function renderDescriptionCell(text) {
      const raw = typeof text === 'string' ? text : '';
      const trimmed = raw.trim();
      const previewLimit = 120;
      const lineCount = trimmed.split(/\r?\n/).length;
      const isLong = trimmed.length > previewLimit || lineCount > 2;
      const fullHtml = escapeHtml(trimmed).replace(/\n/g, '<br>');
      if (!isLong) {
        return `<td class="wrap beskrivning-cell">${fullHtml || '-'}</td>`;
      }
      const preview = escapeHtml(trimmed.slice(0, previewLimit)).replace(/\n/g, '<br>');
      return `<td class="wrap beskrivning-cell long-desc" data-full="${fullHtml}">${preview}‚Ä¶ <span class="show-more">[visa mer]</span></td>`;
    }

    function formatShortDate(dateStr) {
      const d = new Date(dateStr);
      const pad = n => n.toString().padStart(2, '0');
      return `${pad(d.getHours())}:${pad(d.getMinutes())}, ${pad(d.getDate())}/${pad(d.getMonth() + 1)}`;
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Description modal
    document.addEventListener('click', function(e) {
      const closeBtn = e.target.closest('.desc-close');
      if (closeBtn) {
        closeBtn.closest('.desc-modal-bg')?.remove();
        return;
      }
      const cell = e.target.closest('.beskrivning-cell.long-desc');
      if (!cell) return;
      const full = cell.getAttribute('data-full') || '';
      const bg = document.createElement('div');
      bg.className = 'desc-modal-bg';
      const modal = document.createElement('div');
      modal.className = 'desc-modal';
      modal.innerHTML = full + '<button type="button" class="desc-close">St√§ng</button>';
      bg.appendChild(modal);
      document.body.appendChild(bg);
    });

    // Toggle done
    document.addEventListener('change', async (e) => {
      const cb = e.target;
      if (!(cb instanceof HTMLInputElement)) return;
      if (!cb.classList.contains('toggle-done')) return;
      const id = cb.getAttribute('data-id');
      const done = cb.checked;
      try {
        const res = await fetch('/api/admin/submissions/' + id + '/done', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ done })
        });
        if (!res.ok) throw new Error('Update failed');
        
        // Move row between tables
        const row = cb.closest('tr');
        const srcTbody = row.parentElement;
        const dstTbody = done ? document.getElementById('doneBody') : document.getElementById('activeBody');
        
        if (dstTbody.querySelector('td[colspan]')) dstTbody.innerHTML = '';
        dstTbody.appendChild(row);
        
        renumberTable('activeTable');
        renumberTable('doneTable');
        
        if (srcTbody && !srcTbody.querySelector('tr[data-id]')) {
          srcTbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px">Inga prints h√§r.</td></tr>';
        }
      } catch (err) {
        cb.checked = !done;
        alert('Kunde inte uppdatera status. F√∂rs√∂k igen.');
      }
    });

    // Delete, claim, unclaim
    document.addEventListener('click', async (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      
      if (target.classList.contains('btn-del')) {
        const id = target.getAttribute('data-id');
        if (!id) return;
        if (!confirm('√Ñr du s√§ker p√• att du vill ta bort denna print?')) return;
        try {
          const res = await fetch('/api/admin/submissions/' + id, { method: 'DELETE' });
          if (!res.ok) throw new Error('Delete failed');
          const row = target.closest('tr');
          const tbody = row.parentElement;
          row.remove();
          renumberTable('activeTable');
          renumberTable('doneTable');
          if (tbody && !tbody.querySelector('tr[data-id]')) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:20px">Inga prints h√§r.</td></tr>';
          }
        } catch (err) {
          alert('Kunde inte ta bort. F√∂rs√∂k igen.');
        }
      } else if (target.classList.contains('btn-claim')) {
        const id = target.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Vill du ta √∂ver denna print?')) return;
        try {
          const res = await fetch('/api/admin/submissions/' + id + '/claim', { method: 'PATCH' });
          if (!res.ok) throw new Error('Claim failed');
          location.reload();
        } catch (err) {
          alert('Kunde inte ta √∂ver. F√∂rs√∂k igen.');
        }
      } else if (target.classList.contains('btn-unclaim')) {
        const id = target.getAttribute('data-id');
        if (!id) return;
        if (!confirm('Vill du √•ngra och flytta tillbaka till Vem som?')) return;
        try {
          const res = await fetch('/api/admin/submissions/' + id + '/unclaim', { method: 'PATCH' });
          if (!res.ok) throw new Error('Unclaim failed');
          location.reload();
        } catch (err) {
          alert('Kunde inte √•ngra. F√∂rs√∂k igen.');
        }
      } else if (target.hasAttribute('data-view-id')) {
        const id = target.getAttribute('data-view-id');
        if (!id) return;
        const ext = (target.getAttribute('data-ext') || '').toLowerCase();
        const url = ext === 'stl' ? `/admin/file/${id}/raw?format=stl` : `/admin/file/${id}/raw`;
        openViewer(url);
      }
    });

    // Sortable tables
    // ===== 3D Viewer Logic =====
    const viewerModal = document.getElementById('viewerModal');
    const closeViewer = document.getElementById('closeViewer');
    const viewer3d = document.getElementById('viewer3d');
    const viewerMsg = document.getElementById('viewerMsg');
    let vRenderer, vScene, vCamera, vControls, vRoot, vAnimId;

    function ensureViewerInit() {
      if (vRenderer) return;
      vScene = new THREE.Scene();
      const w = viewer3d.clientWidth, h = viewer3d.clientHeight;
      vCamera = new THREE.PerspectiveCamera(50, w / h, 0.01, 5000);
      vCamera.position.set(0.6, 0.35, 0.9);
      vRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      vRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      vRenderer.setSize(w, h);
      viewer3d.innerHTML = '';
      viewer3d.appendChild(vRenderer.domElement);
      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.9);
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(1, 1, 1);
      vScene.add(hemi, dir);
      vControls = new THREE.OrbitControls(vCamera, vRenderer.domElement);
      vControls.enableDamping = true;
      vRoot = new THREE.Group();
      vScene.add(vRoot);
      const grid = new THREE.GridHelper(1, 10, 0x406080, 0x203040);
      grid.material.opacity = 0.2; grid.material.transparent = true; vScene.add(grid);
      animateViewer();
      window.addEventListener('resize', onViewerResize);
    }

    function onViewerResize() {
      if (!vRenderer) return;
      const w = viewer3d.clientWidth, h = viewer3d.clientHeight;
      vRenderer.setSize(w, h);
      vCamera.aspect = w / h; vCamera.updateProjectionMatrix();
    }

    function animateViewer() {
      vAnimId = requestAnimationFrame(animateViewer);
      if (vControls) vControls.update();
      if (vRenderer && vScene && vCamera) vRenderer.render(vScene, vCamera);
    }

    function clearViewer() {
      if (!vRoot) return;
      while (vRoot.children.length) vRoot.remove(vRoot.children[0]);
    }

    function frameObject(obj) {
      const box = new THREE.Box3().setFromObject(obj);
      const size = new THREE.Vector3(); const center = new THREE.Vector3();
      box.getSize(size); box.getCenter(center);
      obj.position.sub(center);
      const maxDim = Math.max(size.x, size.y, size.z) || 1;
      const fov = vCamera.fov * (Math.PI/180);
      let camDist = Math.abs(maxDim / Math.sin(fov/2));
      camDist *= 0.7;
      vCamera.position.set(camDist, camDist*0.25, camDist);
      vCamera.near = camDist/100; vCamera.far = camDist*100; vCamera.updateProjectionMatrix();
      vControls.target.set(0,0,0);
    }

    function openViewer(url) {
      viewerModal.classList.add('show');
      ensureViewerInit();
      clearViewer();
      onViewerResize();
      viewerMsg.textContent = 'Laddar modell...';
      const lower = url.toLowerCase();
      if (lower.endsWith('.stl') || lower.includes('format=stl')) {
        const loader = new THREE.STLLoader();
        loader.load(url, (geom) => {
          const mat = new THREE.MeshStandardMaterial({ color: 0x93c5fd, metalness:0.1, roughness:0.8 });
          const mesh = new THREE.Mesh(geom, mat);
          vRoot.add(mesh);
          frameObject(vRoot);
          viewerMsg.textContent = '';
        }, undefined, (e)=>{ viewerMsg.textContent = 'Kunde inte l√§sa STL.'; });
      } else {
        const loader = new THREE.ThreeMFLoader();
        loader.load(url, (group) => {
          vRoot.add(group);
          frameObject(vRoot);
          viewerMsg.textContent = '';
        }, undefined, (e)=>{ viewerMsg.textContent = 'Kunde inte l√§sa 3MF.'; });
      }
    }

    closeViewer.addEventListener('click', ()=>{
      viewerModal.classList.remove('show');
    });
    window.addEventListener('click',(e)=>{ if(e.target===viewerModal){ viewerModal.classList.remove('show'); }});

    function initSortable(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const tbody = table.tBodies[0];
      const headers = table.querySelectorAll('thead th.sortable');
      let current = { index: null, dir: 'asc' };

      function getCellValue(row, idx, type) {
        const cell = row.children[idx];
        if (!cell) return '';
        const ds = cell.getAttribute('data-sort');
        if (type === 'date') {
          const n = ds ? parseFloat(ds) : Date.parse(cell.textContent.trim());
          return Number.isNaN(n) ? 0 : n;
        }
        return (ds || cell.textContent || '').trim().toLowerCase();
      }

      function sortBy(index, type) {
        const rows = Array.from(tbody.querySelectorAll('tr[data-id]'));
        const dir = current.index === index && current.dir === 'asc' ? 'desc' : 'asc';

        rows.sort((a, b) => {
          const va = getCellValue(a, index, type);
          const vb = getCellValue(b, index, type);
          if (type === 'date') {
            return dir === 'asc' ? va - vb : vb - va;
          }
          const res = String(va).localeCompare(String(vb), 'sv', { sensitivity: 'base' });
          return dir === 'asc' ? res : -res;
        });

        rows.forEach(r => tbody.appendChild(r));
        headers.forEach(h => h.removeAttribute('aria-sort'));
        const active = Array.from(headers).find(h => parseInt(h.dataset.index, 10) === index);
        if (active) active.setAttribute('aria-sort', dir === 'asc' ? 'ascending' : 'descending');
        current = { index, dir };
        renumberTable(tableId);
      }

      headers.forEach(h => {
        h.addEventListener('click', () => {
          const index = parseInt(h.dataset.index, 10);
          const type = h.dataset.type || 'text';
          sortBy(index, type);
        });
      });
    }

    function renumberTable(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const rows = table.tBodies[0].querySelectorAll('tr[data-id]');
      rows.forEach((r, i) => {
        const first = r.children[0];
        if (first) first.textContent = i + 1;
      });
    }

    // Profile modal functionality
    const profileModal = document.getElementById('profileModal');
    const userDisplay = document.getElementById('userDisplay');
    const closeModal = document.getElementById('closeModal');
    const profileForm = document.getElementById('profileForm');
    const profileAlert = document.getElementById('profileAlert');

    userDisplay.addEventListener('click', async () => {
      profileModal.classList.add('show');
      try {
        const res = await fetch('/api/admin/user');
        const userData = await res.json();
        document.getElementById('currentUsername').value = userData.username;
      } catch (err) {
        console.error('Failed to fetch user data', err);
      }
    });

    closeModal.addEventListener('click', () => {
      profileModal.classList.remove('show');
      profileForm.reset();
      profileAlert.innerHTML = '';
    });

    window.addEventListener('click', (e) => {
      if (e.target === profileModal) {
        profileModal.classList.remove('show');
        profileForm.reset();
        profileAlert.innerHTML = '';
      }
    });

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newUsername = document.getElementById('newUsername').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword && newPassword !== confirmPassword) {
        showAlert('L√∂senorden matchar inte!', 'error');
        return;
      }

      if (!currentPassword) {
        showAlert('Du m√•ste ange ditt nuvarande l√∂senord', 'error');
        return;
      }

      if (!newUsername && !newPassword) {
        showAlert('Du m√•ste √§ndra minst anv√§ndarnamn eller l√∂senord', 'error');
        return;
      }

      const saveBtn = document.getElementById('saveProfileBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Sparar...';

      try {
        const res = await fetch('/api/admin/profile', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            currentPassword,
            newUsername: newUsername || undefined,
            newPassword: newPassword || undefined
          })
        });

        const data = await res.json();

        if (res.ok) {
          showAlert('Profil uppdaterad! Loggar in med nya uppgifter...', 'success');
          setTimeout(() => {
            window.location.href = '/admin';
          }, 1500);
        } else {
          showAlert(data.message || 'Kunde inte uppdatera profil', 'error');
          saveBtn.disabled = false;
          saveBtn.textContent = 'Spara √§ndringar';
        }
      } catch (err) {
        console.error('Profile update error:', err);
        showAlert('Ett fel uppstod. F√∂rs√∂k igen.', 'error');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Spara √§ndringar';
      }
    });

    function showAlert(message, type) {
      profileAlert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }
  </script>
</body>
</html>
